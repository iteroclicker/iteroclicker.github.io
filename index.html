<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Emoji Clicker</title>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        width: 100vw;
        height: 100vh;
        margin: 0;
        overflow: hidden;
        background: #0a0a0a;
        touch-action: none;
        font-family: sans-serif;
        user-select: none;
      }
      canvas {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        width: 100% !important;
        height: 100% !important;
      }
      #hud {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 10;
      }
      #score_box {
        position: absolute;
        top: 10px;
        right: 14px;
        text-align: right;
        transition:
          opacity 0.3s,
          right 0.3s;
        max-width: 55vw;
      }
      #score_val {
        font-size: clamp(22px, 4.5vw, 54px);
        font-weight: 900;
        color: #fff;
        line-height: 1;
        text-shadow:
          0 0 20px rgba(255, 200, 0, 0.5),
          0 2px 8px rgba(0, 0, 0, 0.8);
        transition: color 0.3s;
        white-space: nowrap;
      }
      #score_sub {
        font-size: clamp(10px, 1.6vw, 13px);
        color: #888;
        margin-top: 3px;
        white-space: nowrap;
      }
      body.light #score_val {
        color: #2c3e50;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      body.light #score_sub {
        color: #5a6a7a;
      }
      .hbtn {
        position: absolute;
        right: 14px;
        width: 50px;
        height: 50px;
        border-radius: 14px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(37, 37, 37, 0.92);
        color: #fff;
        pointer-events: all;
        transition:
          background 0.3s,
          transform 0.12s,
          border-color 0.3s;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
      }
      .hbtn:active {
        transform: scale(0.88);
      }
      body.light .hbtn {
        background: rgba(240, 244, 248, 0.82);
        color: #2c3e50;
        border-color: rgba(60, 80, 100, 0.18);
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
      }
      #btn_save {
        bottom: 166px;
      }
      #btn_theme {
        bottom: 106px;
      }
      #btn_sound {
        bottom: 46px;
      }
      #btn_open {
        position: absolute;
        top: 14px;
        width: 50px;
        height: 50px;
        border-radius: 14px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(37, 37, 37, 0.95);
        color: #fff;
        pointer-events: all;
        z-index: 20;
        transition:
          background 0.3s,
          transform 0.12s,
          left 0.3s,
          border-color 0.3s;
        box-shadow: 0 2px 14px rgba(0, 0, 0, 0.5);
      }
      #btn_open:active {
        transform: scale(0.88);
      }
      body.light #btn_open {
        background: rgba(240, 244, 248, 0.9);
        color: #2c3e50;
        border-color: rgba(60, 80, 100, 0.18);
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
      }
      #boost_bar {
        position: absolute;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 13px;
        color: #ffd700;
        font-weight: 900;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
        opacity: 0;
        transition: opacity 0.4s;
        pointer-events: none;
        white-space: nowrap;
      }
      @media (max-width: 600px) {
        body.menu_open .hbtn {
          opacity: 0;
          pointer-events: none;
        }
        body.menu_open #score_box {
          opacity: 0;
          pointer-events: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="hud">
      <div id="score_box">
        <div id="score_val">üí∞ 0</div>
        <div id="score_sub">0/—Å √ó1</div>
      </div>
      <button id="btn_open">‚ò∞</button>
      <button id="btn_save" class="hbtn">üíæ</button>
      <button id="btn_theme" class="hbtn">üåô</button>
      <button id="btn_sound" class="hbtn">üîä</button>
      <div id="boost_bar"></div>
    </div>
    <script>
      "use strict";
      document.addEventListener("contextmenu", (e) => e.preventDefault());

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  Cfg ‚Äî –≤—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class Cfg {
        static THEMES = {
          dark: {
            bg: 0x0a0a0a,
            txt: 0xffffff,
            mbg: 0x131318,
            btn: 0x252530,
            sub: 0x888888,
            brd: 0x333340,
          },
          light: {
            bg: 0xf0f4f8,
            txt: 0x2c3e50,
            mbg: 0xfafcff,
            btn: 0xedf1f5,
            sub: 0x5a6a7a,
            brd: 0x9aaabb,
          },
        };
        static TIERS = ["", "K", "M", "B", "T", "Qa", "Qi", "Sx"];
        static MENU_TOP = 80;
        static TAB_NAMES = [
          "üõí –ú–∞–≥–∞–∑–∏–Ω",
          "üé® –°–∫–∏–Ω—ã",
          "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
          "üëæ –û–± –∏–≥—Ä–µ",
        ];
        static BG_EM = [
          "ü¶Ü",
          "üí∞",
          "‚≠ê",
          "üíé",
          "üéÆ",
          "‚ú®",
          "üèÜ",
          "üéØ",
          "üé≤",
          "üåü",
          "üöÄ",
          "üéà",
          "üçÄ",
          "üé™",
          "ü¶ã",
          "üåà",
        ];
        static SPARK_EM = ["‚ú®", "üí´", "‚≠ê", "üåü", "üí•"];
        static SKINS = [
          "ü¶Ü",
          "üëΩ",
          "üéÉ",
          "ü•∂",
          "üí©",
          "üçî",
          "üíé",
          "üóø",
          "ü•ë",
          "ü¶ñ",
          "üöÄ",
          "ü¶Ñ",
          "üî•",
          "üëë",
          "üéà",
          "üßä",
          "üê∏",
          "ü§°",
          "üëª",
          "ü¶Ä",
          "üêô",
          "ü¶ë",
          "üåµ",
          "üçÑ",
          "üê≤",
          "ü¶Å",
          "üêØ",
          "ü¶ä",
          "üê∫",
          "ü¶ù",
          "ü§†",
          "üßô",
          "üßü",
          "üßõ",
          "ü§ñ",
          "üëæ",
          "üé≠",
          "üåÄ",
          "üíÄ",
          "üåô",
          "‚òÄÔ∏è",
          "üçï",
          "üç£",
          "üßÉ",
          "üé∏",
          "ü™ê",
        ];
        static UPGRADES = {
          power: {base: 20, sc: 1.45, lbl: "–ö–ª–∏–∫ +1", sub: "–°–∏–ª–∞ –∫–ª–∏–∫–∞"},
          auto: {base: 100, sc: 1.55, lbl: "–ê–≤—Ç–æ +1", sub: "–í —Å–µ–∫—É–Ω–¥—É"},
          pond: {base: 2000, sc: 1.65, lbl: "–ü—Ä—É–¥ +20", sub: "–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥"},
          farm: {
            base: 15000,
            sc: 1.75,
            lbl: "–§–µ—Ä–º–∞ +120",
            sub: "–°–µ–ª—å—Å–∫–æ–µ —Ö–æ–∑—è–π—Å—Ç–≤–æ",
          },
          factory: {base: 1e5, sc: 1.85, lbl: "–ó–∞–≤–æ–¥ +600", sub: "–ò–Ω–¥—É—Å—Ç—Ä–∏—è"},
          lab: {base: 8e5, sc: 2.0, lbl: "–õ–∞–±–∞ +3000", sub: "–ù–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥"},
          mult: {base: 5000, sc: 4.0, lbl: "–ú—É–ª—å—Ç √ó2", sub: "–£–¥–≤–∞–∏–≤–∞–µ—Ç –≤—Å—ë"},
          crit: {
            base: 2500,
            sc: 2.2,
            lbl: "–ö—Ä–∏—Ç +5%",
            sub: "–£—Ä–æ–Ω √ó3 (–º–∞–∫—Å 35%)",
          },
          storm: {
            base: 50000,
            sc: 5.0,
            lbl: "–ë—É—Ä—è –∫–ª–∏–∫–æ–≤",
            sub: "–ê–≤—Ç–æ-–∫–ª–∏–∫ 5—Å",
          },
          luck: {base: 10000, sc: 3.0, lbl: "–£–¥–∞—á–∞ +10%", sub: "–®–∞–Ω—Å √ó2 –¥—Ä–æ–ø–∞"},
        };
        static ACHIEV = [
          {
            id: "c1",
            ico: "üñ±Ô∏è",
            name: "–ü–µ—Ä–≤—ã–π –∫–ª–∏–∫",
            chk: (s) => s.t_clicks >= 1,
          },
          {
            id: "c100",
            ico: "üíØ",
            name: "100 –∫–ª–∏–∫–æ–≤",
            chk: (s) => s.t_clicks >= 100,
          },
          {
            id: "c1k",
            ico: "üèÖ",
            name: "1000 –∫–ª–∏–∫–æ–≤",
            chk: (s) => s.t_clicks >= 1000,
          },
          {
            id: "c10k",
            ico: "üéñÔ∏è",
            name: "10 000 –∫–ª–∏–∫–æ–≤",
            chk: (s) => s.t_clicks >= 10000,
          },
          {id: "e1k", ico: "üåü", name: "–¢—ã—Å—è—á–Ω–∏–∫", chk: (s) => s.t_earn >= 1e3},
          {
            id: "e1m",
            ico: "üí∞",
            name: "–ú–∏–ª–ª–∏–æ–Ω–µ—Ä",
            chk: (s) => s.t_earn >= 1e6,
          },
          {
            id: "e1b",
            ico: "üíé",
            name: "–ú–∏–ª–ª–∏–∞—Ä–¥–µ—Ä",
            chk: (s) => s.t_earn >= 1e9,
          },
          {
            id: "e1t",
            ico: "üëë",
            name: "–¢—Ä–∏–ª–ª–∏–æ–Ω–µ—Ä",
            chk: (s) => s.t_earn >= 1e12,
          },
          {
            id: "buy1",
            ico: "üõí",
            name: "–ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞",
            chk: (s) => Object.values(s.upg).some((u) => u.lvl > 0),
          },
          {
            id: "frnz",
            ico: "üî•",
            name: "–í –∫—É—Ä–∞–∂–µ! (8+ –∫–ª–∏–∫–æ–≤/—Å)",
            chk: (s) => s.max_cps >= 8,
          },
          {
            id: "a100",
            ico: "ü§ñ",
            name: "–ê–≤—Ç–æ 100/—Å",
            chk: (s) => s.auto >= 100,
          },
          {
            id: "a1k",
            ico: "‚ö°",
            name: "–ê–≤—Ç–æ 1000/—Å",
            chk: (s) => s.auto >= 1000,
          },
          {
            id: "gold",
            ico: "‚≠ê",
            name: "–ó–æ–ª–æ—Ç–∞—è —É–¥–∞—á–∞",
            chk: (s) => s.g_caught >= 1,
          },
          {
            id: "pres",
            ico: "‚ôæÔ∏è",
            name: "–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ",
            chk: (s) => s.prest_n >= 1,
          },
          {
            id: "sk6",
            ico: "üé®",
            name: "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä (6 —Å–∫–∏–Ω–æ–≤)",
            chk: (s) => s.skins_n >= 6,
          },
          {
            id: "sk16",
            ico: "üñºÔ∏è",
            name: "–ú–∞—Å—Ç–µ—Ä –æ–±–ª–∏–∫–∞ (16+)",
            chk: (s) => s.skins_n >= 16,
          },
          {
            id: "boost",
            ico: "‚ö°",
            name: "–ü–µ—Ä–≤—ã–π –±—É—Å—Ç",
            chk: (s) => s.boosts_used >= 1,
          },
          {
            id: "crit",
            ico: "üí•",
            name: "–ö—Ä–∏—Ç! (50 –∫—Ä–∏—Ç–æ–≤)",
            chk: (s) => s.t_crits >= 50,
          },
        ];
        static fmt(n) {
          n = Math.floor(n);
          if (n < 1000) return String(n);
          const i = Math.min(
            Math.floor(Math.log10(n) / 3),
            Cfg.TIERS.length - 1,
          );
          return (
            (n / Math.pow(10, i * 3)).toFixed(1).replace(/\.0$/, "") +
            Cfg.TIERS[i]
          );
        }
        static lerp_c(a, b, t) {
          const r = (c) =>
            Math.round(
              ((a >> c) & 0xff) + (((b >> c) & 0xff) - ((a >> c) & 0xff)) * t,
            );
          return (r(16) << 16) | (r(8) << 8) | r(0);
        }
        static upg_price(u) {
          return Math.floor(u.base * Math.pow(u.sc, u.lvl));
        }
        static sec(ms) {
          return Math.floor(ms / 1000);
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  EventBus ‚Äî pub/sub —Ä–∞–∑–≤—è–∑–∫–∞ –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class EventBus {
        #listeners = {};
        on(ev, fn) {
          (this.#listeners[ev] ??= []).push(fn);
          return this;
        }
        off(ev, fn) {
          this.#listeners[ev] = (this.#listeners[ev] || []).filter(
            (f) => f !== fn,
          );
        }
        emit(ev, d) {
          (this.#listeners[ev] || []).forEach((f) => f(d));
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  AudioSvc ‚Äî –∑–≤—É–∫–æ–≤–æ–π —Å–µ—Ä–≤–∏—Å
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class AudioSvc {
        #ctx = null;
        #on = true;
        play(freq, type = "sine", dur = 0.12, vol = 0.07) {
          if (!this.#on) return;
          try {
            if (!this.#ctx)
              this.#ctx = new (
                window.AudioContext || window.webkitAudioContext
              )();
            const o = this.#ctx.createOscillator(),
              g = this.#ctx.createGain();
            o.type = type;
            o.frequency.value = freq;
            g.gain.setValueAtTime(vol, this.#ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(
              0.001,
              this.#ctx.currentTime + dur,
            );
            o.connect(g);
            g.connect(this.#ctx.destination);
            o.start();
            o.stop(this.#ctx.currentTime + dur + 0.01);
          } catch (e) {}
        }
        toggle() {
          this.#on = !this.#on;
          return this.#on;
        }
        get muted() {
          return !this.#on;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  ThemeSvc ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π —Å –ø–ª–∞–≤–Ω—ã–º –ø–µ—Ä–µ—Ö–æ–¥–æ–º
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class ThemeSvc {
        #cur = "dark";
        #prev = "dark";
        #t = 1;
        col = {...Cfg.THEMES.dark};

        get name() {
          return this.#cur;
        }

        toggle() {
          this.#prev = this.#cur;
          this.#cur = this.#cur === "dark" ? "light" : "dark";
          this.#t = 0;
          document.body.classList.toggle("light", this.#cur === "light");
          document.getElementById("btn_theme").textContent =
            this.#cur === "dark" ? "üåô" : "üåû";
        }

        apply(name) {
          this.#cur = name;
          this.#prev = name;
          this.#t = 1;
          this.col = {...Cfg.THEMES[name]};
          document.body.classList.toggle("light", name === "light");
          document.getElementById("btn_theme").textContent =
            name === "dark" ? "üåô" : "üåû";
        }

        tick(delta) {
          if (this.#t >= 1) return false;
          this.#t = Math.min(1, this.#t + 0.05 * delta);
          const c1 = Cfg.THEMES[this.#prev],
            c2 = Cfg.THEMES[this.#cur];
          this.col = {
            bg: Cfg.lerp_c(c1.bg, c2.bg, this.#t),
            txt: Cfg.lerp_c(c1.txt, c2.txt, this.#t),
            mbg: Cfg.lerp_c(c1.mbg, c2.mbg, this.#t),
            btn: Cfg.lerp_c(c1.btn, c2.btn, this.#t),
            sub: Cfg.lerp_c(c1.sub, c2.sub, this.#t),
            brd: Cfg.lerp_c(c1.brd, c2.brd, this.#t),
          };
          return true;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  GameState ‚Äî –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã, –±–µ–∑ –ª–æ–≥–∏–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∞
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class GameState {
        score = 0;
        click_pow = 1;
        mult = 1;
        auto = 0;
        crit = 0;
        luck_mult = 1;
        t_earn = 0;
        t_clicks = 0;
        t_crits = 0;
        g_caught = 0;
        max_cps = 0;
        prest_n = 0;
        prest_mult = 1;
        skins_n = 1;
        boosts_used = 0;
        boost_ms = 0;
        boost_cd = 0;
        boost_dur = 20000;
        storm_ms = 0;
        storm_cd = 0;
        upg = Object.fromEntries(
          Object.entries(Cfg.UPGRADES).map(([k, v]) => [k, {...v, lvl: 0}]),
        );
        unlocked = {};
        cur_tab = 0;
        menu_open = false;
        menu_w = 350;
        scroll_y = 0;
        scroll_tgt = 0;
        max_scroll = 0;
        dk_scale = 1;
        dk_rot = 0;
        dk_rot_vel = 0;
        shake = 0;
        clicks = [];
        auto_timer = 0;
        g_active = false;
        g_ms = 0;
        g_next = 45000;
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  SaveSvc ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ localStorage
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class SaveSvc {
        #KEY = "ec3";
        #state;
        #theme;
        #skin_ref;
        #unlocked_skins_ref;

        constructor(state, theme_svc, skin_ref, unlocked_skins_ref) {
          this.#state = state;
          this.#theme = theme_svc;
          this.#skin_ref = skin_ref;
          this.#unlocked_skins_ref = unlocked_skins_ref;
        }

        save(duck_text) {
          const S = this.#state;
          try {
            localStorage.setItem(
              this.#KEY,
              JSON.stringify({
                score: S.score,
                click_pow: S.click_pow,
                mult: S.mult,
                auto: S.auto,
                crit: S.crit,
                t_earn: S.t_earn,
                t_clicks: S.t_clicks,
                t_crits: S.t_crits,
                g_caught: S.g_caught,
                max_cps: S.max_cps,
                prest_n: S.prest_n,
                prest_mult: S.prest_mult,
                skins_n: S.skins_n,
                boosts_used: S.boosts_used,
                luck_mult: S.luck_mult,
                unlocked: S.unlocked,
                theme: this.#theme.name,
                unlocked_skins: Array.from(this.#unlocked_skins_ref),
                upg: Object.fromEntries(
                  Object.entries(S.upg).map(([k, v]) => [k, {lvl: v.lvl}]),
                ),
                dk: duck_text || "ü¶Ü",
                ts: Date.now(),
              }),
            );
          } catch (e) {}
        }

        load() {
          const S = this.#state;
          let off_gain = 0;
          try {
            const raw = localStorage.getItem(this.#KEY);
            if (!raw) return 0;
            const d = JSON.parse(raw);
            [
              "score",
              "click_pow",
              "mult",
              "auto",
              "crit",
              "t_earn",
              "t_clicks",
              "t_crits",
              "g_caught",
              "max_cps",
              "prest_n",
              "prest_mult",
              "skins_n",
              "boosts_used",
              "luck_mult",
              "unlocked",
            ].forEach((k) => {
              if (d[k] !== undefined) S[k] = d[k];
            });
            if (d.upg)
              Object.keys(d.upg).forEach((k) => {
                if (S.upg[k]) S.upg[k].lvl = d.upg[k].lvl || 0;
              });
            if (d.theme) this.#theme.apply(d.theme);
            if (d.dk) this.#skin_ref.value = d.dk;
            if (d.unlocked_skins?.length) {
              d.unlocked_skins.forEach((s) => this.#unlocked_skins_ref.add(s));
              S.skins_n = this.#unlocked_skins_ref.size;
            }
            if (d.ts && S.auto > 0) {
              const secs = Math.min((Date.now() - d.ts) / 1000, 3600);
              off_gain = Math.floor(secs * S.auto * S.mult);
              if (off_gain > 0) {
                S.score += off_gain;
                S.t_earn += off_gain;
              }
            }
          } catch (e) {}
          return off_gain;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  RenderSys ‚Äî PIXI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, —Å–ª–æ–∏ —Å—Ü–µ–Ω—ã
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class RenderSys {
        app;
        bg_layer;
        world;
        menu_cont;
        ui_layer;
        scroll_cont;
        mask_g;
        sbar_g;
        menu_bg;
        click_area;
        duck;
        g_duck;
        combo_lbl;
        toast_layer;

        constructor() {
          this.app = new PIXI.Application({
            backgroundColor: 0x0a0a0a,
            antialias: true,
            autoDensity: true,
            resolution: window.devicePixelRatio || 1,
          });
          document.body.insertBefore(
            this.app.view,
            document.getElementById("hud"),
          );

          this.bg_layer = new PIXI.Container();
          this.world = new PIXI.Container();
          this.menu_cont = new PIXI.Container();
          this.ui_layer = new PIXI.Container();
          this.scroll_cont = new PIXI.Container();
          this.mask_g = new PIXI.Graphics();
          this.sbar_g = new PIXI.Graphics();
          this.menu_bg = new PIXI.Graphics();
          this.click_area = new PIXI.Graphics();

          this.menu_bg.eventMode = "static";
          this.mask_g.eventMode = "none";
          this.click_area.eventMode = "static";
          this.click_area.cursor = "pointer";

          this.app.stage.addChild(
            this.bg_layer,
            this.world,
            this.menu_cont,
            this.ui_layer,
          );
          this.menu_cont.addChild(
            this.menu_bg,
            this.scroll_cont,
            this.mask_g,
            this.sbar_g,
          );
          this.scroll_cont.mask = this.mask_g;
          this.world.addChild(this.click_area);

          this.duck = new PIXI.Text("ü¶Ü", {fontSize: 160});
          this.duck.anchor.set(0.5);
          this.world.addChild(this.duck);

          this.g_duck = new PIXI.Text("‚≠ê", {fontSize: 64});
          this.g_duck.anchor.set(0.5);
          this.g_duck.visible = false;
          this.g_duck.eventMode = "static";
          this.g_duck.cursor = "pointer";
          this.world.addChild(this.g_duck);

          this.combo_lbl = new PIXI.Text("", {
            fontSize: 40,
            fill: 0xffa500,
            fontWeight: "900",
            strokeThickness: 5,
            stroke: 0,
          });
          this.combo_lbl.anchor.set(0.5);
          this.combo_lbl.visible = false;
          this.ui_layer.addChild(this.combo_lbl);

          this.toast_layer = new PIXI.Container();
          this.ui_layer.addChild(this.toast_layer);
        }

        get screen() {
          return this.app.screen;
        }
        resize(w, h) {
          this.app.renderer.resize(w, h);
        }
        set_bg(color) {
          this.app.renderer.background.color = color;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  ToastSys ‚Äî –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class ToastSys {
        #render;
        #list = [];

        constructor(render_sys) {
          this.#render = render_sys;
        }

        show(txt) {
          const t = new PIXI.Text(txt, {
            fontSize: 18,
            fill: 0xffffff,
            fontWeight: "900",
            stroke: 0x000000,
            strokeThickness: 5,
            align: "center",
          });
          t.anchor.set(0.5);
          t.position.set(
            this.#render.screen.width / 2,
            this.#render.screen.height * 0.8 - this.#list.length * 44,
          );
          t.alpha = 0;
          t.ttl = 3.0;
          this.#render.toast_layer.addChild(t);
          this.#list.push(t);
        }

        tick(dt) {
          for (let i = this.#list.length - 1; i >= 0; i--) {
            const t = this.#list[i];
            t.ttl -= dt;
            if (t.ttl > 2.5) t.alpha = Math.min(1, (3 - t.ttl) * 6);
            else if (t.ttl < 0.5) t.alpha = Math.max(0, t.ttl * 2);
            if (t.ttl <= 0) {
              t.destroy();
              this.#render.toast_layer.removeChild(t);
              this.#list.splice(i, 1);
            }
          }
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  FloaterSys ‚Äî —Ñ–æ–Ω–æ–≤—ã–µ –ø–ª–∞–≤–∞—é—â–∏–µ —ç–º–æ–¥–∑–∏
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class FloaterSys {
        #render;
        #theme;
        #list = [];

        constructor(render_sys, theme_svc) {
          this.#render = render_sys;
          this.#theme = theme_svc;
          for (let i = 0; i < 16; i++) this.#spawn(Math.random() * 2200);
        }

        #spawn(start_y) {
          const t = new PIXI.Text(
            Cfg.BG_EM[Math.floor(Math.random() * Cfg.BG_EM.length)],
            {fontSize: 50 + Math.random() * 90},
          );
          t.anchor.set(0.5);
          t.x = Math.random() * this.#render.screen.width;
          t.y = start_y ?? this.#render.screen.height + 80;
          t.alpha =
            this.#theme.name === "light"
              ? 0.12 + Math.random() * 0.12
              : 0.05 + Math.random() * 0.1;
          t.vx = (Math.random() - 0.5) * 0.35;
          t.vy = -(0.2 + Math.random() * 0.45);
          t.rot_v = (Math.random() - 0.5) * 0.003;
          this.#render.bg_layer.addChild(t);
          this.#list.push(t);
        }

        tick(delta) {
          const base = this.#theme.name === "light" ? 0.12 : 0.05;
          this.#list.forEach((f) => {
            f.x += f.vx * delta;
            f.y += f.vy * delta;
            f.rotation += f.rot_v * delta;
            if (f.alpha < base - 0.02 || f.alpha > base + 0.14)
              f.alpha = base + Math.random() * 0.1;
            if (f.y < -120) {
              f.y = this.#render.screen.height + 70;
              f.x = Math.random() * this.#render.screen.width;
            }
          });
          while (this.#list.length < 18) this.#spawn();
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  ParticleSys ‚Äî —á–∏—Å–ª–∞ –∏ –∏—Å–∫—Ä—ã –ø—Ä–∏ –∫–ª–∏–∫–µ (object pool)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class ParticleSys {
        #render;
        #pops = [];
        #sparks = [];
        #duck_ref;

        constructor(render_sys, duck_ref) {
          this.#render = render_sys;
          this.#duck_ref = duck_ref;
        }

        pop(txt, x, y, fill, size) {
          const p = new PIXI.Text(txt, {
            fontSize: size,
            fill,
            fontWeight: "900",
            strokeThickness: 4,
            stroke: 0,
          });
          p.position.set(x, y);
          p.anchor.set(0.5);
          p.l = 1;
          p.vy = -5;
          p.vx = (Math.random() - 0.5) * 4;
          this.#render.world.addChild(p);
          this.#pops.push(p);
        }

        spark() {
          const em =
            Cfg.SPARK_EM[Math.floor(Math.random() * Cfg.SPARK_EM.length)];
          const dk = this.#duck_ref;
          const s = new PIXI.Text(em, {fontSize: 16 + Math.random() * 12});
          s.position.set(
            dk.x + (Math.random() - 0.5) * 140,
            dk.y + (Math.random() - 0.5) * 140,
          );
          s.vx = (Math.random() - 0.5) * 18;
          s.vy = (Math.random() - 0.5) * 14 - 7;
          s.l = 1;
          this.#render.world.addChild(s);
          this.#sparks.push(s);
        }

        tick(delta) {
          for (let i = this.#pops.length - 1; i >= 0; i--) {
            const p = this.#pops[i];
            p.x += p.vx * delta;
            p.y += p.vy * delta;
            p.vy += 0.22 * delta;
            p.l -= 0.022 * delta;
            p.alpha = p.l;
            if (p.l <= 0) {
              p.destroy();
              this.#pops.splice(i, 1);
            }
          }
          for (let i = this.#sparks.length - 1; i >= 0; i--) {
            const s = this.#sparks[i];
            s.x += s.vx * delta;
            s.y += s.vy * delta;
            s.vy += 0.5 * delta;
            s.l -= 0.032 * delta;
            s.alpha = s.l;
            if (s.l <= 0) {
              s.destroy();
              this.#sparks.splice(i, 1);
            }
          }
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  GoldDuckSys ‚Äî –∑–æ–ª–æ—Ç–∞—è —É—Ç–∫–∞
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class GoldDuckSys {
        #state;
        #render;
        #particle;
        #audio;
        #bus;
        #toast;

        constructor(
          state,
          render_sys,
          particle_sys,
          audio_svc,
          event_bus,
          toast_sys,
        ) {
          this.#state = state;
          this.#render = render_sys;
          this.#particle = particle_sys;
          this.#audio = audio_svc;
          this.#bus = event_bus;
          this.#toast = toast_sys;

          render_sys.g_duck.on("pointerdown", (e) => {
            e.stopPropagation();
            if (!state.g_active) return;
            const b = Math.max(
              200,
              Math.floor(
                state.score * 0.1 + state.click_pow * state.mult * 200,
              ),
            );
            state.score += b;
            state.t_earn += b;
            state.g_caught++;
            state.g_active = false;
            render_sys.g_duck.visible = false;
            state.shake = 18;
            audio_svc.play(1200, "sine", 0.5, 0.18);
            particle_sys.pop(
              "+" + Cfg.fmt(b) + "!",
              render_sys.g_duck.x,
              render_sys.g_duck.y,
              0xffd700,
              54,
            );
            event_bus.emit("ach_check");
            event_bus.emit("ui_update");
          });
        }

        tick(ms, now) {
          const S = this.#state,
            gd = this.#render.g_duck;
          S.g_ms += ms;
          if (!S.g_active && S.g_ms >= S.g_next) {
            S.g_active = true;
            S.g_ms = 0;
            S.g_next = (30 + Math.random() * 50) * 1000;
            const m = 80,
              W = this.#render.screen.width,
              H = this.#render.screen.height;
            gd.position.set(
              m + Math.random() * (W - m * 2),
              m + Math.random() * (H - m * 2),
            );
            gd.visible = true;
            gd.alpha = 1;
            this.#audio.play(800, "sine", 0.3, 0.1);
            this.#toast.show("‚≠ê –ó–æ–ª–æ—Ç–∞—è —É—Ç–∫–∞! –õ–æ–≤–∏!");
          }
          if (S.g_active) {
            const rem = 1 - S.g_ms / 7000;
            if (rem <= 0) {
              S.g_active = false;
              gd.visible = false;
            } else {
              gd.alpha = Math.min(1, rem * 3);
              gd.scale.set(0.9 + Math.sin(now / 160) * 0.22);
              gd.rotation = Math.sin(now / 380) * 0.35;
              gd.x += Math.sin(now / 800) * 0.5;
              gd.y += Math.cos(now / 1100) * 0.4;
            }
          }
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  ShopView ‚Äî –≤–∫–ª–∞–¥–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ (–∫–Ω–æ–ø–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class ShopView {
        cont;
        _h = 0;
        #rows = [];
        #prestige_row;
        #boost_row;
        #state;
        #audio;
        #bus;
        #theme;
        #toast;

        constructor(state, audio_svc, event_bus, theme_svc, toast_sys) {
          this.#state = state;
          this.#audio = audio_svc;
          this.#bus = event_bus;
          this.#theme = theme_svc;
          this.#toast = toast_sys;
          this.cont = new PIXI.Container();
          this.#build_upgrades();
          this.#build_prestige();
          this.#build_boost();
        }

        #mk_row(lbl_text, sub_text, on_click) {
          const c = new PIXI.Container();
          c.eventMode = "static";
          c.cursor = "pointer";
          const bg = new PIXI.Graphics();
          const tl = new PIXI.Text("", {fontSize: 14, fontWeight: "bold"});
          const ds = new PIXI.Text("", {fontSize: 10});
          const pr = new PIXI.Text("", {fontSize: 13, fontWeight: "bold"});
          tl.position.set(10, 7);
          ds.position.set(10, 31);
          c.addChild(bg, tl, ds, pr);
          this.cont.addChild(c);
          c.on("pointerdown", (e) => {
            e.stopPropagation();
            on_click();
          });
          return {c, bg, tl, ds, pr};
        }

        #build_upgrades() {
          Object.keys(this.#state.upg).forEach((id) => {
            const row = this.#mk_row("", " ", () => {
              const S = this.#state,
                u = S.upg[id],
                price = Cfg.upg_price(u);
              if (S.score < price || (id === "crit" && S.crit >= 0.35)) return;
              S.score -= price;
              u.lvl++;
              if (id === "power") S.click_pow++;
              else if (id === "auto") S.auto++;
              else if (id === "pond") S.auto += 20;
              else if (id === "farm") S.auto += 120;
              else if (id === "factory") S.auto += 600;
              else if (id === "lab") S.auto += 3000;
              else if (id === "mult") S.mult *= 2;
              else if (id === "crit") S.crit = Math.min(0.35, S.crit + 0.05);
              else if (id === "luck") S.luck_mult = 1 + u.lvl * 0.1;
              this.#audio.play(523, "sine", 0.14, 0.08);
              this.#bus.emit("ach_check");
              this.#bus.emit("ui_update");
            });
            row.id = id;
            this.#rows.push(row);
          });
        }

        #build_prestige() {
          const c = new PIXI.Container();
          c.eventMode = "static";
          c.cursor = "pointer";
          const bg = new PIXI.Graphics();
          const tl = new PIXI.Text("‚ú® –ü–†–ï–°–¢–ò–ñ", {
            fontSize: 14,
            fontWeight: "900",
            fill: 0xffd700,
          });
          const ds = new PIXI.Text("", {fontSize: 10, fill: 0xaaaaaa});
          tl.position.set(10, 7);
          ds.position.set(10, 29);
          c.addChild(bg, tl, ds);
          this.cont.addChild(c);
          c.on("pointerdown", (e) => {
            e.stopPropagation();
            this.#do_prestige();
          });
          this.#prestige_row = {c, bg, tl, ds};
        }

        #do_prestige() {
          const S = this.#state;
          if (S.t_earn < 1e9) return;
          S.prest_n++;
          S.prest_mult = 1 + S.prest_n * 0.5;
          const keep = {...S.unlocked},
            sk = S.skins_n;
          S.score = 0;
          S.click_pow = 1;
          S.mult = S.prest_mult;
          S.auto = 0;
          S.crit = 0;
          S.luck_mult = 1;
          S.t_earn = 0;
          S.t_clicks = 0;
          S.max_cps = 0;
          S.g_caught = 0;
          S.t_crits = 0;
          Object.values(S.upg).forEach((u) => (u.lvl = 0));
          S.unlocked = keep;
          S.skins_n = sk;
          this.#audio.play(880, "sine", 0.7, 0.15);
          this.#toast.show(
            "‚ú® –ü—Ä–µ—Å—Ç–∏–∂! x" + S.prest_mult.toFixed(1) + " –Ω–∞–≤—Å–µ–≥–¥–∞!",
          );
          this.#bus.emit("ui_update");
        }

        #build_boost() {
          const c = new PIXI.Container();
          c.eventMode = "static";
          c.cursor = "pointer";
          const bg = new PIXI.Graphics();
          const tl = new PIXI.Text("‚ö° –ë–£–°–¢ √ó3 (20—Å)", {
            fontSize: 14,
            fontWeight: "900",
            fill: 0x00ccff,
          });
          const ds = new PIXI.Text("–£—Ç—Ä–æ–∏—Ç—å –¥–æ—Ö–æ–¥ –Ω–∞ 20 —Å–µ–∫—É–Ω–¥", {
            fontSize: 10,
            fill: 0xaaaaaa,
          });
          tl.position.set(10, 7);
          ds.position.set(10, 29);
          c.addChild(bg, tl, ds);
          this.cont.addChild(c);
          c.on("pointerdown", (e) => {
            e.stopPropagation();
            this.#use_boost();
          });
          this.#boost_row = {c, bg, tl, ds};
        }

        #use_boost() {
          const S = this.#state;
          if (S.boost_ms > 0 || S.boost_cd > 0) return;
          const cost = Math.floor(Math.max(1000, S.auto * S.mult * 5));
          if (S.score < cost) return;
          S.score -= cost;
          S.boost_ms = S.boost_dur;
          S.boost_cd = 90000;
          S.boosts_used++;
          this.#audio.play(880, "sine", 0.3, 0.12);
          this.#toast.show("‚ö° –ë–£–°–¢ –ê–ö–¢–ò–í–ï–ù 20—Å!");
          this.#bus.emit("ach_check");
          this.#bus.emit("ui_update");
        }

        render(menu_w, col, is_light = false) {
          const S = this.#state;
          this.#rows.forEach((row) => {
            const u = S.upg[row.id];
            const is_max = row.id === "crit" && S.crit >= 0.35;
            const price = Cfg.upg_price(u),
              can = S.score >= price && !is_max;
            row.tl.text = u.lbl + "  [" + u.lvl + "]";
            row.tl.style.fill = col.txt;
            row.ds.text = is_max ? "MAX" : u.sub;
            row.ds.style.fill = col.sub;
            row.pr.text = is_max ? "" : Cfg.fmt(price) + " üí∞";
            row.pr.style.fill = can ? 0x2ecc71 : 0xe74c3c;
            row.pr.position.set(menu_w - row.pr.width - 38, 18);
            const fill = is_light ? 0xffffff : col.btn;
            row.bg
              .clear()
              .beginFill(fill, is_light ? 0.7 : 1)
              .lineStyle(2, can ? 0x2ecc71 : col.brd)
              .drawRoundedRect(0, 0, menu_w - 26, 54, 11);
          });

          const pr = this.#prestige_row,
            can_p = S.t_earn >= 1e9;
          pr.c.visible = can_p || S.prest_n > 0;
          if (pr.c.visible) {
            const nm = (1 + (S.prest_n + 1) * 0.5).toFixed(1);
            pr.ds.text = can_p
              ? "–°–±—Ä–æ—Å ‚Üí x" + nm + " –Ω–∞–≤—Å–µ–≥–¥–∞!"
              : "–ù—É–∂–Ω–æ 1B (" + Cfg.fmt(S.t_earn) + ")";
            const fill = can_p
              ? is_light
                ? 0xfff8e0
                : 0x2e2000
              : is_light
                ? 0xffffff
                : col.btn;
            pr.bg
              .clear()
              .beginFill(fill, is_light ? 0.8 : 1)
              .lineStyle(2, can_p ? 0xffd700 : col.brd)
              .drawRoundedRect(0, 0, menu_w - 26, 52, 11);
          }

          const bst = this.#boost_row,
            cd = S.boost_cd > 0;
          const cost = Math.floor(Math.max(1000, S.auto * S.mult * 5));
          const can_b = !cd && S.score >= cost && S.boost_ms <= 0;
          bst.tl.text =
            S.boost_ms > 0
              ? "‚ö° –ê–ö–¢–ò–í–ï–ù " + Cfg.sec(S.boost_ms) + "—Å"
              : cd
                ? "‚è≥ –ö–î " + Cfg.sec(S.boost_cd) + "—Å"
                : "‚ö° –ë–£–°–¢ √ó3 (" + Cfg.fmt(cost) + " üí∞)";
          const bst_fill = is_light ? 0xffffff : col.btn;
          bst.bg
            .clear()
            .beginFill(bst_fill, is_light ? 0.7 : 1)
            .lineStyle(2, can_b ? 0x00ccff : col.brd)
            .drawRoundedRect(0, 0, menu_w - 26, 54, 11);
        }

        layout(menu_w) {
          let y = 10;
          this.#rows.forEach((r) => {
            r.c.position.set(13, y);
            y += 63;
          });
          const pr = this.#prestige_row;
          pr.c.position.set(13, y);
          if (pr.c.visible) y += 62;
          this.#boost_row.c.position.set(13, y);
          y += 62;
          this._h = y + 20;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  SkinsView ‚Äî –≤–∫–ª–∞–¥–∫–∞ —Å–∫–∏–Ω–æ–≤
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class SkinsView {
        cont;
        _h = 0;
        #rows = [];
        #duck_ref;
        #unlocked;
        #state;
        #bus;

        constructor(state, event_bus, duck_ref, unlocked_skins) {
          this.#state = state;
          this.#bus = event_bus;
          this.#duck_ref = duck_ref;
          this.#unlocked = unlocked_skins;
          this.cont = new PIXI.Container();
          Cfg.SKINS.forEach((em) => {
            const b = new PIXI.Container();
            b.eventMode = "static";
            b.cursor = "pointer";
            const bg = new PIXI.Graphics(),
              t = new PIXI.Text(em, {fontSize: 26});
            t.anchor.set(0.5);
            b.addChild(bg, t);
            b.on("pointerdown", (ev) => {
              ev.stopPropagation();
              duck_ref.text = em;
              state.shake = 5;
              if (!unlocked_skins.has(em)) {
                unlocked_skins.add(em);
                state.skins_n = unlocked_skins.size;
              }
              event_bus.emit("ach_check");
              event_bus.emit("ui_update");
            });
            this.cont.addChild(b);
            this.#rows.push({b, bg, t});
          });
        }

        render(menu_w, col) {
          const bs = (menu_w - 60) / 5;
          this.#rows.forEach((e) => {
            const active = e.t.text === this.#duck_ref.text;
            e.bg
              .clear()
              .beginFill(active ? 0x1a3a5c : col.btn)
              .lineStyle(2, active ? 0x3498db : col.brd)
              .drawRoundedRect(0, 0, bs, bs, 11);
          });
        }

        layout(menu_w) {
          const bs = (menu_w - 60) / 5;
          this.#rows.forEach((e, i) => {
            e.b.position.set(
              14 + (i % 5) * (bs + 8),
              10 + Math.floor(i / 5) * (bs + 8),
            );
            e.t.position.set(bs / 2, bs / 2);
            e.t.style.fontSize = bs * 0.5;
          });
          this._h = 10 + Math.ceil(Cfg.SKINS.length / 5) * (bs + 8) + 20;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  StatsView ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –∫–∞—Ä—Ç–æ—á–∫–∏ 2√óN + –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class StatsView {
        cont;
        _h = 0;
        #state;
        #cards = [];
        #sec_lbl;
        #ach_rows = [];
        // –∫–∞—Ä—Ç–æ—á–∫–∏: {bg, ico_t, val_t, lbl_t}
        static #CARD_DEFS = [
          {ico: "üí∞", lbl: "–°—á—ë—Ç", key: "score"},
          {ico: "üìà", lbl: "–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ", key: "t_earn"},
          {ico: "üñ±Ô∏è", lbl: "–ö–ª–∏–∫–æ–≤", key: "t_clicks"},
          {ico: "üí•", lbl: "–ö—Ä–∏—Ç–æ–≤", key: "t_crits"},
          {ico: "ü§ñ", lbl: "–ê–≤—Ç–æ/—Å–µ–∫", key: "_auto_ps"},
          {ico: "üî•", lbl: "–ú–∞–∫—Å CPS", key: "max_cps"},
          {ico: "‚≠ê", lbl: "–ó–æ–ª–æ—Ç. —É—Ç–∫–∏", key: "g_caught"},
          {ico: "‚ôæÔ∏è", lbl: "–ü—Ä–µ—Å—Ç–∏–∂–µ–π", key: "prest_n"},
          {ico: "üé®", lbl: "–°–∫–∏–Ω–æ–≤", key: "skins_n"},
          {ico: "‚ö°", lbl: "–ë—É—Å—Ç–æ–≤", key: "boosts_used"},
        ];

        constructor(state) {
          this.#state = state;
          this.cont = new PIXI.Container();

          StatsView.#CARD_DEFS.forEach(() => {
            const bg = new PIXI.Graphics();
            const ico_t = new PIXI.Text("", {fontSize: 22});
            const val_t = new PIXI.Text("", {
              fontSize: 15,
              fontWeight: "900",
              fill: 0xffffff,
            });
            const lbl_t = new PIXI.Text("", {fontSize: 10, fill: 0x888888});
            ico_t.anchor.set(0.5, 0);
            val_t.anchor.set(0.5, 0);
            lbl_t.anchor.set(0.5, 0);
            this.cont.addChild(bg, ico_t, val_t, lbl_t);
            this.#cards.push({bg, ico_t, val_t, lbl_t});
          });

          this.#sec_lbl = new PIXI.Text("–î–û–°–¢–ò–ñ–ï–ù–ò–Ø", {
            fontSize: 12,
            fontWeight: "900",
            fill: 0x888888,
          });
          this.cont.addChild(this.#sec_lbl);

          Cfg.ACHIEV.forEach((a) => {
            const row = new PIXI.Container();
            const bg = new PIXI.Graphics();
            const ico = new PIXI.Text(a.ico, {fontSize: 14});
            const nm = new PIXI.Text(a.name, {
              fontSize: 11,
              fontWeight: "bold",
            });
            const mk = new PIXI.Text("üîí", {fontSize: 11});
            ico.position.set(8, 6);
            nm.position.set(32, 7);
            row.addChild(bg, ico, nm, mk);
            this.cont.addChild(row);
            this.#ach_rows.push({row, bg, nm, mk, id: a.id});
          });
        }

        render(menu_w, col, is_light = false) {
          const S = this.#state;
          const ps = Math.floor(S.auto * S.mult * (S.boost_ms > 0 ? 3 : 1));
          const vals = {...S, _auto_ps: ps};
          const cw = (menu_w - 14 * 3) / 2;

          StatsView.#CARD_DEFS.forEach((def, i) => {
            const c = this.#cards[i];
            c.ico_t.text = def.ico;
            c.val_t.text = Cfg.fmt(vals[def.key] ?? 0);
            c.lbl_t.text = def.lbl;
            c.val_t.style.fill = col.txt;
            c.lbl_t.style.fill = col.sub;
            const card_fill = is_light ? 0xffffff : col.btn;
            c.bg
              .clear()
              .beginFill(card_fill, is_light ? 0.75 : 0.9)
              .lineStyle(1, col.brd)
              .drawRoundedRect(0, 0, cw, 64, 10);
          });

          this.#sec_lbl.style.fill = col.sub;

          const aw = menu_w - 28;
          this.#ach_rows.forEach((r) => {
            const done = !!S.unlocked[r.id];
            const done_fill = is_light ? 0xe0f5e0 : 0x0d280d;
            r.bg
              .clear()
              .beginFill(
                done ? done_fill : is_light ? 0xffffff : col.btn,
                done ? 1 : 0.5,
              )
              .lineStyle(1, done ? 0x2ecc71 : col.brd)
              .drawRoundedRect(0, 0, aw, 32, 7);
            r.nm.style.fill = done ? (is_light ? 0x1a7a1a : 0x2ecc71) : col.sub;
            r.mk.text = done ? "‚úÖ" : "üîí";
            r.mk.position.set(aw - 24, 8);
          });
          this._h = this.#_compute_h(menu_w);
        }

        layout(menu_w) {
          const cw = (menu_w - 14 * 3) / 2;
          const cx = (i) => 14 + (i % 2) * (cw + 14);
          const cy = (i) => 14 + Math.floor(i / 2) * 76;
          this.#cards.forEach(({bg, ico_t, val_t, lbl_t}, i) => {
            const x = cx(i),
              y = cy(i);
            bg.position.set(x, y);
            ico_t.position.set(x + cw / 2, y + 8);
            val_t.position.set(x + cw / 2, y + 34);
            lbl_t.position.set(x + cw / 2, y + 51);
          });
          const rows = Math.ceil(StatsView.#CARD_DEFS.length / 2);
          const sec_y = 14 + rows * 76 + 8;
          this.#sec_lbl.position.set(14, sec_y);
          let ay = sec_y + 20;
          this.#ach_rows.forEach((r) => {
            r.row.position.set(14, ay);
            ay += 38;
          });
          this._h = ay + 16;
        }

        #_compute_h(menu_w) {
          const rows = Math.ceil(StatsView.#CARD_DEFS.length / 2);
          return 14 + rows * 76 + 28 + this.#ach_rows.length * 38 + 16;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  AboutView ‚Äî –≤–∫–ª–∞–¥–∫–∞ "–æ–± –∏–≥—Ä–µ"
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class AboutView {
        cont;
        _h = 0;
        #items = [];

        constructor() {
          this.cont = new PIXI.Container();
          const lines = [
            {txt: "üëæ", sz: 72, fill: 0xffffff},
            {txt: "redeflesq", sz: 28, fill: 0x00ccff},
            {txt: "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏–≥—Ä—ã", sz: 14, fill: 0x888888},
            {txt: "v3.0  2025", sz: 12, fill: 0x444455},
            {txt: "", sz: 12, fill: 0x444455},
            {txt: "–°–æ–≤–µ—Ç—ã:", sz: 15, fill: 0xffd700},
            {txt: "‚Ä¢ –ñ–º–∏ –±—ã—Å—Ç—Ä–æ ‚Äî FRENZY x2!", sz: 12, fill: 0x888888},
            {txt: "‚Ä¢ –õ–æ–≤–∏ ‚≠ê ‚Äî –±–æ–Ω—É—Å 10% —Å—á—ë—Ç–∞", sz: 12, fill: 0x888888},
            {txt: "‚Ä¢ –ü—Ä–µ—Å—Ç–∏–∂ –¥–∞—ë—Ç x1.5 –Ω–∞–≤—Å–µ–≥–¥–∞", sz: 12, fill: 0x888888},
            {txt: "‚Ä¢ –ë—É—Å—Ç √ó3 ‚Äî —é–∑–∞–π —á–∞—â–µ!", sz: 12, fill: 0x888888},
            {txt: "‚Ä¢ –õ–∞–±–∞ ‚Äî –ª—É—á—à–∏–π –∞–≤—Ç–æ –≤ –∏–≥—Ä–µ", sz: 12, fill: 0x888888},
          ];
          let y = 20;
          lines.forEach((l) => {
            const t = new PIXI.Text(l.txt, {
              fontSize: l.sz,
              fill: l.fill,
              fontWeight: "bold",
              align: "center",
            });
            t.anchor.set(0.5, 0);
            t.y = y;
            this.cont.addChild(t);
            this.#items.push(t);
            y += l.sz + 10;
          });
          this._h = y + 20;
        }

        layout(menu_w) {
          this.#items.forEach((t) => {
            t.x = menu_w / 2;
          });
          let y = 20;
          this.#items.forEach((t) => {
            t.y = y;
            y += t.style.fontSize + 10;
          });
          this._h = y + 20;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  MenuCtrl ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫, –≤–∫–ª–∞–¥–∫–∏, –ø—Ä–æ–∫—Ä—É—Ç–∫–∞, layout
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class MenuCtrl {
        #state;
        #render;
        #theme;
        #shop;
        #skins;
        #stats;
        #about;
        #tabs = [];
        #tab_conts = [];
        #mhdr_bg;
        #mhdr_lbl;

        constructor(
          state,
          render_sys,
          theme_svc,
          shop_view,
          skins_view,
          stats_view,
          about_view,
        ) {
          this.#state = state;
          this.#render = render_sys;
          this.#theme = theme_svc;
          this.#shop = shop_view;
          this.#skins = skins_view;
          this.#stats = stats_view;
          this.#about = about_view;

          this.#mhdr_bg = new PIXI.Graphics();
          this.#mhdr_lbl = new PIXI.Text("EMOJI CLICKER", {
            fontSize: 15,
            fontWeight: "900",
            fill: 0xffffff,
          });
          render_sys.menu_cont.addChild(this.#mhdr_bg, this.#mhdr_lbl);

          Cfg.TAB_NAMES.forEach((nm, i) => {
            const c = new PIXI.Container();
            c.eventMode = "static";
            c.cursor = "pointer";
            const bg = new PIXI.Graphics();
            const t = new PIXI.Text(nm, {
              fontSize: 11,
              fontWeight: "bold",
              align: "center",
            });
            t.anchor.set(0.5);
            c.addChild(bg, t);
            render_sys.menu_cont.addChild(c);
            c.on("pointerdown", (e) => {
              e.stopPropagation();
              state.cur_tab = i;
              this.layout();
            });
            this.#tabs.push({c, bg, t});
          });

          [shop_view, skins_view, stats_view, about_view].forEach((v) => {
            render_sys.scroll_cont.addChild(v.cont);
            this.#tab_conts.push(v.cont);
          });
        }

        render() {
          const S = this.#state,
            col = this.#theme.col,
            mw = S.menu_w;
          const tw = mw / Cfg.TAB_NAMES.length;
          const is_light = this.#theme.name === "light";

          this.#render.set_bg(col.bg);
          this.#mhdr_bg
            .clear()
            .beginFill(col.mbg)
            .drawRect(0, 0, mw, Cfg.MENU_TOP);
          this.#mhdr_bg
            .lineStyle(1, col.brd)
            .moveTo(0, Cfg.MENU_TOP - 1)
            .lineTo(mw, Cfg.MENU_TOP - 1);
          this.#mhdr_lbl.style.fill = col.txt;
          this.#render.menu_bg
            .clear()
            .beginFill(col.mbg)
            .drawRect(
              0,
              Cfg.MENU_TOP,
              mw,
              this.#render.screen.height - Cfg.MENU_TOP,
            );

          const tab_act_fill = is_light ? 0xd6e8ff : 0x1a2a3a;
          const tab_act_brd = is_light ? 0x4a90d9 : 0x3498db;
          this.#tabs.forEach(({c, bg, t}, i) => {
            const act = i === S.cur_tab;
            bg.clear()
              .beginFill(act ? tab_act_fill : col.btn, act ? 1 : 0.6)
              .lineStyle(1, act ? tab_act_brd : col.brd)
              .drawRoundedRect(0, 0, tw - 6, 34, 8);
            t.style.fill = act ? tab_act_brd : col.sub;
          });

          this.#shop.render(mw, col, is_light);
          this.#skins.render(mw, col);
          this.#stats.render(mw, col, is_light);
        }

        layout() {
          const S = this.#state,
            r = this.#render;
          const w = window.innerWidth,
            h = window.innerHeight;
          r.resize(w, h);
          const mob = w < 600;
          S.menu_w = mob ? Math.floor(w * 0.9) : 370;
          const mw = S.menu_w;

          document.body.classList.toggle("menu_open", S.menu_open);
          const btn_open = document.getElementById("btn_open");
          btn_open.style.left =
            (S.menu_open ? Math.round(r.menu_cont.x + mw + 8) : 14) + "px";

          const score_box = document.getElementById("score_box");
          if (S.menu_open && !mob) {
            score_box.style.right = "78px";
          } else {
            score_box.style.right = "14px";
          }

          r.click_area.clear().beginFill(0, 0.001).drawRect(0, 0, w, h);
          r.mask_g
            .clear()
            .beginFill(0)
            .drawRect(0, Cfg.MENU_TOP, mw, h - Cfg.MENU_TOP);

          const cx = S.menu_open && !mob ? mw + (w - mw) / 2 : w / 2;
          r.duck.position.set(cx, h / 2);
          r.combo_lbl.position.set(cx, h * 0.12);
          r.duck.style.fontSize =
            Math.min(w - (S.menu_open ? mw : 0), h) * 0.38;

          this.#mhdr_bg
            .clear()
            .beginFill(this.#theme.col.mbg)
            .drawRect(0, 0, mw, Cfg.MENU_TOP);
          this.#mhdr_lbl.position.set(14, 10);

          const tw = mw / Cfg.TAB_NAMES.length;
          const is_light = this.#theme.name === "light";
          const tab_act_fill = is_light ? 0xd6e8ff : 0x1a2a3a;
          const tab_act_brd = is_light ? 0x4a90d9 : 0x3498db;
          this.#tabs.forEach(({c, bg, t}, i) => {
            c.position.set(i * tw + 3, 38);
            bg.clear()
              .beginFill(
                i === S.cur_tab ? tab_act_fill : this.#theme.col.btn,
                i === S.cur_tab ? 1 : 0.6,
              )
              .lineStyle(1, i === S.cur_tab ? tab_act_brd : this.#theme.col.brd)
              .drawRoundedRect(0, 0, tw - 6, 34, 8);
            t.position.set((tw - 6) / 2, 17);
          });

          this.#tab_conts.forEach((c, i) => (c.visible = i === S.cur_tab));

          this.#shop.layout(mw);
          this.#skins.layout(mw);
          this.#stats.layout(mw);
          this.#about.layout(mw);

          const views = [this.#shop, this.#skins, this.#stats, this.#about];
          const cur_h = views[S.cur_tab]._h || 400;
          S.max_scroll = Math.min(0, h - Cfg.MENU_TOP - cur_h);
          this.render();
        }

        draw_sbar() {
          const S = this.#state,
            sg = this.#render.sbar_g;
          sg.clear();
          if (!S.menu_open || S.max_scroll >= 0) {
            sg.visible = false;
            return;
          }
          sg.visible = true;
          const h = this.#render.screen.height,
            vh = h - Cfg.MENU_TOP;
          const bh = Math.max(36, (vh / (vh - S.max_scroll)) * vh);
          const pct = S.max_scroll < 0 ? S.scroll_y / S.max_scroll : 0;
          const by = Cfg.MENU_TOP + pct * (vh - bh);
          sg.beginFill(0x666666, 0.6).drawRoundedRect(
            S.menu_w - 7,
            by,
            4,
            bh,
            2,
          );
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  InputCtrl ‚Äî –∫–ª–∏–∫–∏, –ø—Ä–æ–∫—Ä—É—Ç–∫–∞, –∫–Ω–æ–ø–∫–∏ HUD
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class InputCtrl {
        #state;
        #render;
        #particle;
        #audio;
        #bus;
        #toast;
        #menu;
        #storm_acc = 0;

        constructor(
          state,
          render_sys,
          particle_sys,
          audio_svc,
          event_bus,
          toast_sys,
          menu_ctrl,
        ) {
          this.#state = state;
          this.#render = render_sys;
          this.#particle = particle_sys;
          this.#audio = audio_svc;
          this.#bus = event_bus;
          this.#toast = toast_sys;
          this.#menu = menu_ctrl;

          render_sys.click_area.on("pointerdown", (e) => this.#on_click(e));
          this.#setup_scroll();
          this.#setup_hud_btns();
        }

        #on_click(e) {
          const S = this.#state;
          if (S.menu_open && e.global.x < S.menu_w) return;
          const now = Date.now();
          S.clicks.push(now);
          S.t_clicks++;
          const cps = S.clicks.length;
          S.max_cps = Math.max(S.max_cps, cps);
          const frenzy = cps >= 8,
            is_crit = Math.random() < S.crit;
          if (is_crit) S.t_crits++;
          const boost_m = S.boost_ms > 0 ? 3 : 1;
          const luck_m =
            Math.random() < 0.1 * (S.luck_mult - 1 + 1) ? S.luck_mult : 1;
          const v = Math.floor(
            S.click_pow *
              S.mult *
              (is_crit ? 3 : 1) *
              (frenzy ? 2 : 1) *
              boost_m *
              luck_m,
          );
          S.score += v;
          S.t_earn += v;
          S.dk_scale = 0.8;
          S.shake = is_crit ? 14 : frenzy ? 8 : 4;
          const amp = 0.1 + cps * 0.028 + (is_crit ? 0.18 : 0);
          S.dk_rot_vel += (Math.random() > 0.5 ? 1 : -1) * amp;
          S.dk_rot_vel = Math.max(-1.5, Math.min(1.5, S.dk_rot_vel));
          this.#audio.play(
            is_crit ? 1100 : 780,
            is_crit ? "square" : "sine",
            is_crit ? 0.18 : 0.07,
            0.06,
          );
          let lbl = "+" + Cfg.fmt(v);
          if (is_crit) lbl += "üí•";
          if (luck_m > 1) lbl += "üçÄ";
          this.#particle.pop(
            lbl,
            e.global.x,
            e.global.y,
            frenzy ? 0xff3333 : is_crit ? 0xff8800 : 0xffcc00,
            is_crit ? 50 : 32,
          );
          const ns = frenzy ? 5 : is_crit ? 3 : 1;
          for (let i = 0; i < ns; i++) this.#particle.spark();
          this.#bus.emit("ach_check");
          this.#bus.emit("ui_update");
        }

        do_storm_tick(ms) {
          const S = this.#state;
          if (S.storm_ms <= 0) return;
          this.#storm_acc += ms;
          while (this.#storm_acc >= 100) {
            this.#storm_acc -= 100;
            const v = Math.floor(
              S.click_pow * S.mult * (S.boost_ms > 0 ? 3 : 1),
            );
            S.score += v;
            S.t_earn += v;
            const dk = this.#render.duck;
            this.#particle.pop(
              "+" + Cfg.fmt(v),
              dk.x + (Math.random() - 0.5) * 80,
              dk.y + (Math.random() - 0.5) * 80,
              0x00ccff,
              24,
            );
            this.#particle.spark();
          }
          this.#bus.emit("ui_update");
        }

        use_storm() {
          const S = this.#state;
          if (S.upg.storm.lvl === 0 || S.storm_cd > 0 || S.storm_ms > 0) return;
          S.storm_ms = 5000;
          S.storm_cd = 60000;
          this.#storm_acc = 0;
          this.#audio.play(660, "square", 0.2, 0.1);
          this.#toast.show("üå™Ô∏è –ë–£–†–Ø –ö–õ–ò–ö–û–í 5—Å!");
        }

        #setup_scroll() {
          const S = this.#state,
            r = this.#render;
          let drag = false,
            dy = 0;
          r.menu_bg.on("pointerdown", (e) => {
            drag = true;
            dy = e.global.y;
            e.stopPropagation();
          });
          window.addEventListener("pointerup", () => (drag = false));
          window.addEventListener("pointermove", (e) => {
            if (drag && S.menu_open) {
              S.scroll_tgt += (e.clientY - dy) * 1.2;
              dy = e.clientY;
            }
          });
          r.app.view.addEventListener(
            "wheel",
            (e) => {
              if (S.menu_open && e.clientX < S.menu_w) S.scroll_tgt -= e.deltaY;
            },
            {passive: true},
          );
        }

        #setup_hud_btns() {
          const S = this.#state;
          document
            .getElementById("btn_open")
            .addEventListener("pointerdown", (e) => {
              e.stopPropagation();
              S.menu_open = !S.menu_open;
              this.#menu.layout();
            });
          document
            .getElementById("btn_save")
            .addEventListener("pointerdown", (e) => {
              e.stopPropagation();
              this.#bus.emit("save");
              this.#toast.show("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            });
          document
            .getElementById("btn_theme")
            .addEventListener("pointerdown", (e) => {
              e.stopPropagation();
              this.#bus.emit("theme_toggle");
            });
          document
            .getElementById("btn_sound")
            .addEventListener("pointerdown", (e) => {
              e.stopPropagation();
              this.#bus.emit("sound_toggle");
            });
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  HudCtrl ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ HTML HUD
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class HudCtrl {
        #state;
        constructor(state) {
          this.#state = state;
        }

        render() {
          const S = this.#state;
          document.getElementById("score_val").textContent =
            "üí∞ " + Cfg.fmt(S.score);
          const ps = Math.floor(S.auto * S.mult * (S.boost_ms > 0 ? 3 : 1));
          let sub =
            Cfg.fmt(ps) +
            "/—Å √ó" +
            (Number.isInteger(S.mult) ? S.mult : S.mult.toFixed(1));
          if (S.prest_n > 0) sub += " ‚ú®" + S.prest_n;
          document.getElementById("score_sub").textContent = sub;

          const bb = document.getElementById("boost_bar");
          if (S.boost_ms > 0) {
            bb.style.opacity = "1";
            bb.textContent = "‚ö° –ë–£–°–¢ √ó3  " + Cfg.sec(S.boost_ms) + "—Å";
          } else if (S.storm_ms > 0) {
            bb.style.opacity = "1";
            bb.textContent = "üå™Ô∏è –ë–£–†–Ø  " + Cfg.sec(S.storm_ms) + "—Å";
          } else bb.style.opacity = "0";
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  GameLoop ‚Äî –≥–ª–∞–≤–Ω—ã–π —Ç–∏–∫, –¥–µ–ª—å—Ç–∞-–≤—Ä–µ–º—è, –æ—Ä–∫–µ—Å—Ç—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class GameLoop {
        #state;
        #render;
        #theme;
        #floater;
        #particle;
        #gold;
        #menu;
        #input;
        #toast;
        #hud;
        #bus;

        constructor(
          state,
          render_sys,
          theme_svc,
          floater_sys,
          particle_sys,
          gold_sys,
          menu_ctrl,
          input_ctrl,
          toast_sys,
          hud_ctrl,
          event_bus,
        ) {
          this.#state = state;
          this.#render = render_sys;
          this.#theme = theme_svc;
          this.#floater = floater_sys;
          this.#particle = particle_sys;
          this.#gold = gold_sys;
          this.#menu = menu_ctrl;
          this.#input = input_ctrl;
          this.#toast = toast_sys;
          this.#hud = hud_ctrl;
          this.#bus = event_bus;
        }

        start() {
          this.#render.app.ticker.add((delta) => this.#tick(delta));
        }

        #tick(delta) {
          const now = Date.now(),
            dt = delta / 60;
          const S = this.#state;
          const ms = this.#render.app.ticker.deltaMS;

          // –¢–µ–º–∞
          if (this.#theme.tick(delta)) this.#menu.render();

          // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
          S.scroll_tgt = Math.max(S.max_scroll, Math.min(0, S.scroll_tgt));
          S.scroll_y += (S.scroll_tgt - S.scroll_y) * 0.2 * delta;
          this.#render.scroll_cont.y = Math.round(S.scroll_y) + Cfg.MENU_TOP;
          this.#menu.draw_sbar();

          // CPS
          S.clicks = S.clicks.filter((t) => now - t < 1000);
          const cps = S.clicks.length;

          // –ë—É—Å—Ç—ã –∏ –±—É—Ä—è
          if (S.boost_ms > 0) S.boost_ms = Math.max(0, S.boost_ms - ms);
          if (S.boost_cd > 0) S.boost_cd = Math.max(0, S.boost_cd - ms);
          if (S.storm_ms > 0) S.storm_ms = Math.max(0, S.storm_ms - ms);
          if (S.storm_cd > 0) S.storm_cd = Math.max(0, S.storm_cd - ms);
          this.#input.do_storm_tick(ms);

          // –ê–≤—Ç–æ –¥–æ—Ö–æ–¥
          S.auto_timer += ms;
          if (S.auto_timer >= 1000 && S.auto > 0) {
            S.auto_timer -= 1000;
            const earned = Math.floor(
              S.auto * S.mult * (cps >= 8 ? 2 : 1) * (S.boost_ms > 0 ? 3 : 1),
            );
            S.score += earned;
            S.t_earn += earned;
            this.#bus.emit("ach_check");
            this.#bus.emit("ui_update");
          }

          // –ö–æ–º–±–æ –ª–µ–π–±–ª
          const cl = this.#render.combo_lbl,
            dk = this.#render.duck;
          if (cps > 2) {
            cl.visible = true;
            cl.text = cps >= 8 ? cps + " FRENZY x2!" : cps + " clk/s";
            const j = cps >= 5 ? (Math.random() - 0.5) * cps : 0;
            cl.position.set(dk.x + j, this.#render.screen.height * 0.12);
            cl.scale.set(1 + Math.sin(now / 110) * 0.09);
            cl.style.fill =
              cps >= 8 ? 0xff3333 : cps >= 5 ? 0xffa500 : 0xffff00;
          } else cl.visible = false;

          // –ê–Ω–∏–º–∞—Ü–∏—è —É—Ç–∫–∏
          S.dk_scale += (1 - S.dk_scale) * 0.2 * delta;
          dk.scale.set(S.dk_scale);
          S.dk_rot_vel *= Math.pow(0.88, delta);
          S.dk_rot += S.dk_rot_vel * 0.04 * delta;
          S.dk_rot += -S.dk_rot * 0.1 * delta;
          dk.rotation = S.dk_rot;

          // –¢—Ä—è—Å–∫–∞
          const w = this.#render.world;
          if (S.shake > 0.2) {
            w.position.set(
              (Math.random() - 0.5) * S.shake,
              (Math.random() - 0.5) * S.shake,
            );
            S.shake *= Math.pow(0.82, delta);
          } else {
            S.shake = 0;
            w.position.set(0, 0);
          }

          // –°–¥–≤–∏–≥ –º–µ–Ω—é
          this.#render.menu_cont.x +=
            ((S.menu_open ? 0 : -S.menu_w) - this.#render.menu_cont.x) *
            0.25 *
            delta;
          const open_left = S.menu_open
            ? Math.round(this.#render.menu_cont.x + S.menu_w + 8)
            : 14;
          document.getElementById("btn_open").style.left = open_left + "px";

          this.#particle.tick(delta);
          this.#toast.tick(dt);
          this.#floater.tick(delta);
          this.#gold.tick(ms, now);
          this.#hud.render();
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  AchSys ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ EventBus)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class AchSys {
        #state;
        #toast;
        #audio;

        constructor(state, toast_sys, audio_svc, event_bus) {
          this.#state = state;
          this.#toast = toast_sys;
          this.#audio = audio_svc;
          event_bus.on("ach_check", () => this.#check());
        }

        #check() {
          Cfg.ACHIEV.forEach((a) => {
            if (!this.#state.unlocked[a.id] && a.chk(this.#state)) {
              this.#state.unlocked[a.id] = true;
              this.#toast.show(a.ico + " " + a.name + "!");
              this.#audio.play(660, "sine", 0.4, 0.1);
            }
          });
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  Game ‚Äî –∫–æ—Ä–Ω–µ–≤–æ–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä / DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      class Game {
        // –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —Å–∏—Å—Ç–µ–º—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –∑–¥–µ—Å—å
        #bus = new EventBus();
        #audio = new AudioSvc();
        #theme = new ThemeSvc();
        #state = new GameState();
        #render = new RenderSys();

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–∫–∏–Ω–∞ –≤ SaveSvc
        #skin_box = {value: "ü¶Ü"};
        #unlocked_skins = new Set(["ü¶Ü"]);

        #save;
        #toast;
        #floater;
        #particle;
        #gold;
        #shop;
        #skins;
        #stats;
        #about;
        #menu;
        #input;
        #hud;
        #ach;
        #loop;

        constructor() {
          this.#wire_services();
          this.#wire_systems();
          this.#wire_events();
          this.#start();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
        #wire_services() {
          this.#save = new SaveSvc(
            this.#state,
            this.#theme,
            this.#skin_box,
            this.#unlocked_skins,
          );
          this.#toast = new ToastSys(this.#render);
          this.#floater = new FloaterSys(this.#render, this.#theme);
          this.#particle = new ParticleSys(this.#render, this.#render.duck);
        }

        #wire_systems() {
          this.#gold = new GoldDuckSys(
            this.#state,
            this.#render,
            this.#particle,
            this.#audio,
            this.#bus,
            this.#toast,
          );
          this.#shop = new ShopView(
            this.#state,
            this.#audio,
            this.#bus,
            this.#theme,
            this.#toast,
          );
          this.#skins = new SkinsView(
            this.#state,
            this.#bus,
            this.#render.duck,
            this.#unlocked_skins,
          );
          this.#stats = new StatsView(this.#state);
          this.#about = new AboutView();
          this.#menu = new MenuCtrl(
            this.#state,
            this.#render,
            this.#theme,
            this.#shop,
            this.#skins,
            this.#stats,
            this.#about,
          );
          this.#input = new InputCtrl(
            this.#state,
            this.#render,
            this.#particle,
            this.#audio,
            this.#bus,
            this.#toast,
            this.#menu,
          );
          this.#hud = new HudCtrl(this.#state);
          this.#ach = new AchSys(
            this.#state,
            this.#toast,
            this.#audio,
            this.#bus,
          );
          this.#loop = new GameLoop(
            this.#state,
            this.#render,
            this.#theme,
            this.#floater,
            this.#particle,
            this.#gold,
            this.#menu,
            this.#input,
            this.#toast,
            this.#hud,
            this.#bus,
          );
        }

        #wire_events() {
          this.#bus.on("ui_update", () => this.#menu.render());
          this.#bus.on("save", () => this.#save.save(this.#render.duck.text));
          this.#bus.on("theme_toggle", () => {
            this.#theme.toggle();
            this.#menu.layout();
          });
          this.#bus.on("sound_toggle", () => {
            const on = this.#audio.toggle();
            document.getElementById("btn_sound").textContent = on ? "üîä" : "üîá";
          });
        }

        #start() {
          const off_gain = this.#save.load();
          this.#render.duck.text = this.#skin_box.value;
          this.#menu.layout();
          window.addEventListener("resize", () => this.#menu.layout());
          setInterval(() => this.#save.save(this.#render.duck.text), 30000);
          window.addEventListener("beforeunload", () =>
            this.#save.save(this.#render.duck.text),
          );
          this.#loop.start();
          if (off_gain > 0)
            setTimeout(
              () =>
                this.#toast.show(
                  "üí§ –ü–æ–∫–∞ –≤–∞—Å –Ω–µ –±—ã–ª–æ: +" + Cfg.fmt(off_gain) + "!",
                ),
              500,
            );
        }
      }

      // –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ 
      window.onload = () => new Game();
    </script>
  </body>
</html>
